#!/bin/sh

## Find the R home directory.
: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
  echo "Could not determine R_HOME."
  exit 1
fi

R="${R_HOME}/bin/R"

: ${PKG_CONFIG="pkg-config"}
version=`${PKG_CONFIG} --version 2>/dev/null`
if test -n "${version}"; then
  if `${PKG_CONFIG} --exists highs`; then
    PKG_CPPFLAGS=`${PKG_CONFIG} --cflags highs`
    PKG_LIBS=`${PKG_CONFIG} --libs highs`
  fi
fi

## Set defaults if pkg-config didn't work or returned empty values
test -z "${PKG_CPPFLAGS}" && \
  PKG_CPPFLAGS="-I/usr/include/highs"
test -z "${PKG_LIBS}" && \
  PKG_LIBS="-lhighs"

## Test whether we can compile and link a minimal program.
rm -f conftest.*

cat > conftest.cc <<EOF
#include <highs/Highs.h>

int
main ()
{
    Highs highs;
    return 0;
}
EOF

PKG_CPPFLAGS="${PKG_CPPFLAGS}" PKG_LIBS="${PKG_LIBS}" _R_SHLIB_BUILD_OBJECTS_SYMBOL_TABLES_=false ${R} CMD SHLIB conftest.cc >/dev/null 2>&1
status=${?}

## If that failed and we got values from pkg-config, try with standard paths
if test ${status} -ne 0; then
  PKG_CPPFLAGS="-I/usr/include/highs"
  PKG_LIBS="-lhighs"
  PKG_CPPFLAGS="${PKG_CPPFLAGS}" PKG_LIBS="${PKG_LIBS}" _R_SHLIB_BUILD_OBJECTS_SYMBOL_TABLES_=false ${R} CMD SHLIB conftest.cc >/dev/null 2>&1
  status=${?}
fi

rm -f conftest.*

if test ${status} -ne 0; then
  echo "Cannot find HiGHS libraries and headers."
  echo "Please install libhighs-dev (deb) or coin-or-HiGHS-devel (rpm)."
  exit 1
fi

sed -e "s|@PKG_CPPFLAGS@|${PKG_CPPFLAGS}|" \
    -e "s|@PKG_LIBS@|${PKG_LIBS}|" \
    src/Makevars.in > src/Makevars

exit 0
